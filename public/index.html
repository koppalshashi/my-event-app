<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Event Registration</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap" rel="stylesheet">
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body { font-family: 'Inter', sans-serif; background-color: #f3f4f6; }
    .step-active { background-color: #10b981; border-color: #10b981; }
    .step-active .step-number { color: white; }
    .hidden { display: none; }
  </style>
</head>
<body class="flex items-center justify-center min-h-screen">

<div class="bg-white p-8 md:p-12 rounded-2xl shadow-xl w-full max-w-lg mx-4 transition-all duration-300">
  <div class="flex items-center justify-between mb-8">
    <div class="flex items-center space-x-2 md:space-x-4">
      <div id="step-1-indicator" class="flex flex-col items-center step-indicator">
        <div class="w-10 h-10 md:w-12 md:h-12 flex items-center justify-center rounded-full border-2 border-gray-300 step-1-number">
          <span class="step-number text-gray-500 font-bold">1</span>
        </div>
        <span class="text-xs md:text-sm mt-2 text-gray-600">Registration</span>
      </div>
      <div class="w-8 md:w-10 h-0.5 bg-gray-300"></div>
      <div id="step-2-indicator" class="flex flex-col items-center step-indicator">
        <div class="w-10 h-10 md:w-12 md:h-12 flex items-center justify-center rounded-full border-2 border-gray-300 step-2-number">
          <span class="step-number text-gray-500 font-bold">2</span>
        </div>
        <span class="text-xs md:text-sm mt-2 text-gray-600">Payment</span>
      </div>
      <div class="w-8 md:w-10 h-0.5 bg-gray-300"></div>
      <div id="step-3-indicator" class="flex flex-col items-center step-indicator">
        <div class="w-10 h-10 md:w-12 md:h-12 flex items-center justify-center rounded-full border-2 border-gray-300 step-3-number">
          <span class="step-number text-gray-500 font-bold">3</span>
        </div>
        <span class="text-xs md:text-sm mt-2 text-gray-600">QR Code</span>
      </div>
    </div>
  </div>

  <!-- Step 1: Registration -->
  <div id="step-1" class="step">
    <h2 class="text-2xl md:text-3xl font-bold mb-4 text-gray-800">Event Registration</h2>
    <form id="registration-form">
      <div class="mb-4">
        <label for="name" class="block text-gray-700 text-sm font-semibold mb-2">Full Name</label>
        <input type="text" id="name" name="name" required class="w-full p-3 rounded-xl border border-gray-300 focus:outline-none focus:ring-2 focus:ring-green-400 transition-all duration-200">
      </div>
      <div class="mb-4">
        <label for="email" class="block text-gray-700 text-sm font-semibold mb-2">Email</label>
        <input type="email" id="email" name="email" required class="w-full p-3 rounded-xl border border-gray-300 focus:outline-none focus:ring-2 focus:ring-green-400 transition-all duration-200">
      </div>
      <div class="mb-4">
        <label for="phone" class="block text-gray-700 text-sm font-semibold mb-2">Phone</label>
        <input type="tel" id="phone" name="phone" required class="w-full p-3 rounded-xl border border-gray-300 focus:outline-none focus:ring-2 focus:ring-green-400 transition-all duration-200">
      </div>
      <div class="mb-6">
        <label for="event" class="block text-gray-700 text-sm font-semibold mb-2">Event</label>
        <select id="event" name="event" required class="w-full p-3 rounded-xl border border-gray-300 focus:outline-none focus:ring-2 focus:ring-green-400 transition-all duration-200">
          <option value="Annual Conference">Annual Conference</option>
          <option value="Tech Summit">Tech Summit</option>
          <option value="Networking Gala">Networking Gala</option>
        </select>
      </div>
      <button type="submit" class="w-full bg-green-500 text-white font-bold py-3 px-6 rounded-xl hover:bg-green-600">Next</button>
    </form>
  </div>

  <!-- Step 2: Payment -->
  <div id="step-2" class="step hidden text-center">
    <h2 class="text-2xl md:text-3xl font-bold mb-4 text-gray-800">Complete Payment</h2>
    <div id="payment-status" class="mb-4 text-lg font-semibold text-gray-600"></div>
    <div id="gpay-button"></div>
    <button id="go-back-payment" class="w-full mt-4 bg-gray-300 text-gray-800 font-bold py-3 px-6 rounded-xl hover:bg-gray-400">Go Back</button>
  </div>

  <!-- Step 3: QR Code -->
  <div id="step-3" class="step hidden text-center">
    <h2 class="text-2xl md:text-3xl font-bold mb-4 text-gray-800">Registration Complete!</h2>
    <div id="qr-code-container" class="flex justify-center mb-6"></div>
    <div class="bg-gray-100 p-6 rounded-xl text-left mb-6">
      <p class="text-gray-700 font-semibold text-lg mb-2">Your Details:</p>
      <p>Name: <span id="display-name"></span></p>
      <p>Email: <span id="display-email"></span></p>
      <p>Event: <span id="display-event"></span></p>
      <p>Amount Paid: â‚¹<span id="display-amount"></span></p>
    </div>
    <button id="download-qr" class="w-full bg-green-500 text-white font-bold py-3 px-6 rounded-xl hover:bg-green-600">Download QR</button>
    <button id="start-over" class="w-full mt-4 bg-gray-300 text-gray-800 font-bold py-3 px-6 rounded-xl hover:bg-gray-400">Start Over</button>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.1/qrcode.min.js"></script>
<script async
  src="https://pay.google.com/gp/p/js/pay.js"
  onload="onGooglePayLoaded()"></script>

<script>
let registrationId = null;
const API_URL = "http://localhost:5000";
const steps = document.querySelectorAll('.step');
const stepIndicators = document.querySelectorAll('.step-indicator > div');

function showStep(stepNumber) {
  steps.forEach(s => s.classList.add('hidden'));
  document.getElementById(`step-${stepNumber}`).classList.remove('hidden');
  stepIndicators.forEach(ind => ind.classList.remove('step-active'));
  for(let i=1;i<=stepNumber;i++) {
    document.getElementById(`step-${i}-indicator`).querySelector('div').classList.add('step-active');
  }
}

document.getElementById('registration-form').addEventListener('submit', async (e)=>{
  e.preventDefault();
  const formData = {
    name: document.getElementById('name').value,
    email: document.getElementById('email').value,
    phone: document.getElementById('phone').value,
    event: document.getElementById('event').value
  };
  try {
    const res = await fetch(`${API_URL}/api/register`,{
      method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(formData)
    });
    const result = await res.json();
    registrationId = result.id;
    showStep(2);
  } catch(err){console.error(err);}
});

function onGooglePayLoaded() {
  const paymentsClient = new google.payments.api.PaymentsClient({environment:'TEST'});
  const button = paymentsClient.createButton({onClick:onGooglePayButtonClicked});
  document.getElementById('gpay-button').appendChild(button);

  const isReadyToPayRequest = {allowedPaymentMethods:[{type:'CARD',parameters:{allowedAuthMethods:['PAN_ONLY','CRYPTOGRAM_3DS'],allowedCardNetworks:['MASTERCARD','VISA']}}]};
  paymentsClient.isReadyToPay(isReadyToPayRequest).then(response=>{
    if(!response.result) document.getElementById('gpay-button').innerHTML='Google Pay Not Available';
  });
}

function onGooglePayButtonClicked() {
  const paymentsClient = new google.payments.api.PaymentsClient({environment:'TEST'});
  const paymentDataRequest = {
    apiVersion: 2,
    apiVersionMinor: 0,
    allowedPaymentMethods: [{
      type: 'CARD',
      parameters: {allowedAuthMethods:['PAN_ONLY','CRYPTOGRAM_3DS'], allowedCardNetworks:['MASTERCARD','VISA']},
      tokenizationSpecification:{type:'PAYMENT_GATEWAY', parameters:{gateway:'example', gatewayMerchantId:'exampleMerchantId'}}
    }],
    merchantInfo:{merchantName:'Event Registration'},
    transactionInfo:{totalPriceStatus:'FINAL', totalPrice:'1500', currencyCode:'INR'}
  };
  paymentsClient.loadPaymentData(paymentDataRequest).then(async paymentData=>{
    // Send payment info to backend
    await fetch(`${API_URL}/api/gpay-notification`,{
      method:'POST', headers:{'Content-Type':'application/json'},
      body:JSON.stringify({
        registrationId,
        amountPaid: 1500,
        payerName: paymentData.paymentMethodData.info.cardDetails,
        transactionId: paymentData.paymentMethodData.tokenizationData.token
      })
    });
    showStep(3);
    displayUserDetails({name:document.getElementById('name').value,email:document.getElementById('email').value,event:document.getElementById('event').value,amountPaid:1500});
    generateQRCode({name:document.getElementById('name').value,email:document.getElementById('email').value,event:document.getElementById('event').value,amountPaid:1500});
  }).catch(err=>console.error(err));
}

function generateQRCode(data){
  qrCodeContainer=document.getElementById('qr-code-container');
  qrCodeContainer.innerHTML='';
  QRCode.toCanvas(document.createElement('canvas'),JSON.stringify(data),{errorCorrectionLevel:'H'},(err,canvas)=>{
    if(!err) qrCodeContainer.appendChild(canvas);
  });
}

function displayUserDetails(data){
  document.getElementById('display-name').textContent=data.name;
  document.getElementById('display-email').textContent=data.email;
  document.getElementById('display-event').textContent=data.event;
  document.getElementById('display-amount').textContent=data.amountPaid;
}

document.getElementById('start-over').addEventListener('click',()=>window.location.reload());
document.getElementById('go-back-payment').addEventListener('click',()=>showStep(1));

showStep(1);
</script>
</body>
</html>
